id: page1
properties:
  title: Movie Search ðŸ”Ž
requests:
  - name: req_search
    type: mongodb_aggregation
    connectionId: mongodb_mflix_movies
    properties:
      pipeline:
        - $match:
            $text:
              $search:
                _nunjucks: "{{ search_input }}"
        - $sort:
            score:
              $meta: textScore
        - $limit: 20
        - $project:
            title: 1
            plot: 1
            likes:
              $ifNull:
                - $likes
                - 0
            liked_by_user:
              $in:
                - _user: id
                - $ifNull:
                    - $liked_by
                    - []

mutations:
  - name: mutation_like_movie
    type: mongodb_update_one
    connectionId: mongodb_mflix_movies
    properties:
      filter:
        _id:
          _state: results.$._id
      update:
        $inc:
          likes: 1
        $push:
          liked_by:
            _user: id

blocks:
  - name: card_search
    type: card
    label:
      title: Search for a movie
    blocks:
      - name: search_input
        type: text_input
        label:
          title: ""
        box:
          width: 16
      - name: search_button
        type: button_input
        box:
          width: 4
        label:
          title: Search
        properties:
          icon: search
        actions:
          onClick:
            - refresh(): req_search
            - set():
                results:
                  _request: req_search
      - name: reset_button
        type: button_input
        box:
          width: 4
        label:
          title: Reset
        properties:
          type: default
          icon: reload
        actions:
          onClick:
            - reset(): true
      - name: results
        type: list
        properties:
          hideAddButton: true
          hideRemoveButton: true
        blocks:
          - name: results.$.description
            type: markdown
            properties:
              content:
                _nunjucks:
                  on:
                    _state: results.$
                  template: |
                    ### {{ title }}
                    {{ plot }}
                    ##### Likes: {{ likes }}
          - name: results.$.like_button
            type: button_input
            label:
              title: Like
            box:
              width: 12
            properties:
              icon: like
              disabled:
                _state: results.$.liked_by_user
            actions:
              onClick:
                - mutate(): mutation_like_movie
                - set():
                    results.$.liked_by_user: true
                    results.$.likes:
                      _mql_expr:
                        $add:
                          - _state: results.$.likes
                          - 1
          - name: results.$.view_button
            type: button_input
            label:
              title: View Details
            box:
              width: 12
            properties:
              icon: table
            actions:
              onClick:
                - pageLink():
                    pageId: page2
                    input:
                      _id:
                        _state: results.$._id
