name: req_genres_by_decade
type: mongodb_aggregation
connectionId: mongodb_mflix_movies
properties:
  pipeline:
    - "$match":
        type: movie
    - "$match":
        "$expr":
          "$and":
            - "$gte":
                - "$year"
                - _state: filter_start_decade
            - "$lt":
                - "$year"
                - "$add":
                    - _state: filter_end_decade
                    - 10
    - "$unwind":
        path: "$genres"
    - "$group":
        _id:
          decade:
            "$subtract":
              - "$year"
              - "$mod":
                  - "$year"
                  - 10
          genre: "$genres"
        count:
          "$sum": 1
    - "$group":
        _id:
          "$concat":
            - "$toString": "$_id.decade"
            - "'s"
        count_genres:
          "$push":
            k: "$_id.genre"
            v: "$count"
    - "$replaceRoot":
        newRoot:
          "$arrayToObject":
            - "$concatArrays":
                - - k: decade
                    v: "$_id"
                - $count_genres

    - "$sort":
        decade: 1
